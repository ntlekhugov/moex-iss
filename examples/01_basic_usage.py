#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MOEX ISS API
============================================

–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞–∫–µ—Ç–∞:
1. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
2. –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã API
3. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV

–ó–∞–ø—É—Å–∫:
    python examples/01_basic_usage.py
"""

import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–∫–µ—Ç—É (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
sys.path.insert(0, str(Path(__file__).parent.parent))

from moex_iss import MOEXClient


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ—Ä–∞."""

    print("=" * 60)
    print("MOEX ISS API ‚Äî –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä")
    print("=" * 60)

    # =========================================================
    # –®–∞–≥ 1: –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç
    # =========================================================
    print("\nüìå –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞")
    print("-" * 40)

    client = MOEXClient()
    print("–ö–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
    print(f"–ë–∞–∑–æ–≤—ã–π URL: {client.BASE_URL}")

    # =========================================================
    # –®–∞–≥ 2: –ò—Å—Å–ª–µ–¥—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É API
    # =========================================================
    print("\nüìå –®–∞–≥ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ MOEX ISS API")
    print("-" * 40)

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–≤–∏–∂–∫–æ–≤ (engines)
    print("\nüîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–≤–∏–∂–∫–∏:")
    engines = client.get_engines()
    for _, row in engines.iterrows():
        print(f"   {row['name']:15} ‚Äî {row.get('title', '')}")

    # –ü–æ–ª—É—á–∞–µ–º —Ä—ã–Ω–∫–∏ —Ñ–æ–Ω–¥–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞
    print("\nüì¶ –†—ã–Ω–∫–∏ —Ñ–æ–Ω–¥–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞ (stock):")
    markets = client.get_markets('stock')
    for _, row in markets.head(5).iterrows():
        market_name = row.get('market_name', row.get('NAME', ''))
        title = row.get('title', row.get('TITLE', ''))
        print(f"   {market_name:15} ‚Äî {title}")

    # =========================================================
    # –®–∞–≥ 3: –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤
    # =========================================================
    print("\nüìå –®–∞–≥ 3: –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã")
    print("-" * 40)

    indices = client.get_available_indices()
    print(f"\n–í—Å–µ–≥–æ –∏–Ω–¥–µ–∫—Å–æ–≤: {len(indices)}")
    print("\n–ü–µ—Ä–≤—ã–µ 10 –∏–Ω–¥–µ–∫—Å–æ–≤:")
    for _, row in indices.head(10).iterrows():
        print(f"   {row['SECID']:15} ‚Äî {row.get('SHORTNAME', '')}")

    # =========================================================
    # –®–∞–≥ 4: –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
    # =========================================================
    print("\nüìå –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö")
    print("-" * 40)

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É IMOEX
    index_code = 'IMOEX'
    print(f"\n–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∏–Ω–¥–µ–∫—Å—É {index_code}...")

    df = client.get_index_history(index_code, start_date='2024-01-01')

    if not df.empty:
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} –∑–∞–ø–∏—Å–µ–π")
        print("\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π:")
        print(df[['TRADEDATE', 'OPEN', 'HIGH', 'LOW', 'CLOSE']].tail().to_string(index=False))

        # –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print("\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   –ü–µ—Ä–∏–æ–¥: {df['TRADEDATE'].min().strftime('%Y-%m-%d')} ‚Äî {df['TRADEDATE'].max().strftime('%Y-%m-%d')}")
        print(f"   –ú–∏–Ω–∏–º—É–º: {df['CLOSE'].min():.2f}")
        print(f"   –ú–∞–∫—Å–∏–º—É–º: {df['CLOSE'].max():.2f}")
        print(f"   –°—Ä–µ–¥–Ω–µ–µ: {df['CLOSE'].mean():.2f}")
    else:
        print("‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    # =========================================================
    # –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ CSV
    # =========================================================
    print("\nüìå –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV")
    print("-" * 40)

    output_file = 'imoex_example.csv'
    success = client.download_to_csv(
        index_code,
        output_file,
        start_date='2024-01-01'
    )

    if success:
        print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ {output_file}")
    else:
        print("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")

    # =========================================================
    # –ì–æ—Ç–æ–≤–æ!
    # =========================================================
    print("\n" + "=" * 60)
    print("–ü—Ä–∏–º–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω!")
    print("=" * 60)


if __name__ == "__main__":
    main()
